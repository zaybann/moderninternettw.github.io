<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottery Background Process & History</title>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; text-align: center; background: #f4f7f6; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: inline-block; min-width: 350px; margin-bottom: 20px; }
        #status { font-weight: bold; font-size: 1.1rem; color: #3498db; margin: 15px 0; }
        
        .history-section { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; }
        th { background: #3498db; color: white; border-radius: 5px; }
        .win-num { font-weight: bold; color: #e74c3c; font-size: 1.1rem; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ° 4D Auto Draw System</h2>
    <div id="status">á€…á€”á€…á€ºá€€á€­á€¯ á€…á€á€„á€ºá€”á€±á€•á€«á€á€Šá€º...</div>
    <div id="debug" style="font-size: 13px; color: #888;">á€¡á€á€»á€­á€”á€ºá€…á€…á€ºá€†á€±á€¸á€”á€±á€á€Šá€º...</div>
</div>

<div class="history-section">
    <h3>ğŸ“œ á€•á€±á€«á€€á€ºá€‚á€á€”á€ºá€¸á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€»á€¬á€¸</h3>
    <table>
        <thead>
            <tr>
                <th>á€”á€±á€·á€›á€€á€º</th>
                <th>á€¡á€á€»á€­á€”á€º</th>
                <th>á€•á€±á€«á€€á€ºá€‚á€á€”á€ºá€¸</th>
            </tr>
        </thead>
        <tbody id="history-list">
            </tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCUk-1FHFjhIVDD4foYuKHM7PyT_A1A1vk",
        authDomain: "twod-aa6c1.firebaseapp.com",
        projectId: "twod-aa6c1",
        storageBucket: "twod-aa6c1.appspot.com",
        messagingSenderId: "674076613631",
        appId: "1:674076613631:android:b21b4027ebe6f6f169e5ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function startDraw() {
        const statusDiv = document.getElementById("status");
        const debugDiv = document.getElementById("debug");

        try {
            const mmTimeFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: 'Asia/Yangon', hour: 'numeric', minute: 'numeric', hour12: false
            });
            
            const parts = mmTimeFormatter.formatToParts(new Date());
            let hh = parseInt(parts.find(p => p.type === 'hour').value);
            let mm = parseInt(parts.find(p => p.type === 'minute').value);

            let targetHourSlot = hh;
            if (mm >= 50) { targetHourSlot = (hh + 1) % 24; }

            debugDiv.innerText = `á€šá€á€¯á€¡á€á€»á€­á€”á€º - ${hh}:${mm} | Target - ${targetHourSlot}:00 á€•á€½á€²`;

            const docRef = doc(db, "lottery_rounds", "current_round");
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();

            if (!data || data.hour_slot !== targetHourSlot) {
                const randomNum = Math.floor(Math.random() * 10000);
                const winningNumber = randomNum.toString().padStart(4, '0');

                // áá‹ á€œá€€á€ºá€›á€¾á€­á€‚á€á€”á€ºá€¸á€¡á€–á€¼á€…á€º update á€œá€¯á€•á€ºá€á€Šá€º
                await setDoc(docRef, {
                    winning_number: winningNumber,
                    hour_slot: targetHourSlot,
                    draw_time: serverTimestamp()
                });

                // á‚á‹ á€•á€±á€«á€€á€ºá€‚á€á€”á€ºá€¸á€™á€¾á€á€ºá€á€™á€ºá€¸ (all_results) á€‘á€²á€á€­á€¯á€· á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€á€Šá€º
                const historyRef = doc(collection(db, "all_results"));
                await setDoc(historyRef, {
                    winning_number: winningNumber,
                    hour_slot: targetHourSlot,
                    date: new Date().toLocaleDateString(),
                    timestamp: serverTimestamp()
                });

                statusDiv.innerText = `${targetHourSlot}:00 á€•á€½á€²á€¡á€á€½á€€á€º (${winningNumber}) á€”á€¾á€­á€¯á€€á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹`;
            } else {
                statusDiv.innerText = `${targetHourSlot}:00 á€•á€½á€²á€¡á€á€½á€€á€º á€‘á€®á€”á€¾á€­á€¯á€€á€ºá€•á€¼á€®á€¸á€á€¬á€¸á€–á€¼á€…á€ºá€•á€«á€á€Šá€ºá‹`;
            }
        } catch (error) {
            statusDiv.innerText = "Error: " + error.message;
        }
    }

    // á€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€»á€¬á€¸á€€á€­á€¯ Real-time á€†á€½á€²á€šá€°á€•á€¼á€á€á€¼á€„á€ºá€¸
    function loadHistory() {
        const q = query(collection(db, "all_results"), orderBy("timestamp", "desc"), limit(10));
        onSnapshot(q, (snapshot) => {
            let html = "";
            snapshot.forEach(doc => {
                const item = doc.data();
                html += `
                    <tr>
                        <td>${item.date}</td>
                        <td>${item.hour_slot}:00</td>
                        <td class="win-num">${item.winning_number}</td>
                    </tr>
                `;
            });
            document.getElementById("history-list").innerHTML = html;
        });
    }

    startDraw();
    loadHistory();
    setInterval(startDraw, 60000); 

</script>
</body>
</html>
