<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ငွေသွင်း/ထုတ် မှတ်တမ်း</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --bg-dark: #001f3f; --bg-card: #003366; --accent: #1890ff; --white: #ffffff; --dim: #a6adb4; }
        body { background-color: var(--bg-dark); color: var(--white); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .header i { font-size: 20px; margin-right: 15px; cursor: pointer; color: var(--accent); }
        .header h2 { font-size: 18px; margin: 0; }

        .history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-card { 
            background: var(--bg-card); padding: 15px; border-radius: 12px; 
            border-left: 5px solid var(--accent); cursor: pointer; transition: 0.2s;
        }
        .history-card:active { transform: scale(0.98); background: #004080; }
        
        .status-pending { color: #faad14; background: rgba(250, 173, 20, 0.15); padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .status-success { color: #52c41a; background: rgba(82, 196, 26, 0.15); padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .status-rejected { color: #ff4d4f; background: rgba(255, 77, 79, 0.15); padding: 2px 8px; border-radius: 4px; font-size: 12px; }

        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .type { font-weight: bold; font-size: 15px; }
        .amount { font-weight: bold; font-size: 16px; color: var(--accent); }
        .date { font-size: 11px; color: var(--dim); }
        
        #loading { text-align: center; margin-top: 50px; }
        #no-data { text-align: center; margin-top: 50px; color: var(--dim); display: none; }

        /* Detail Modal Styles */
        .modal-detail p { margin: 10px 0; font-size: 14px; color: #eee; text-align: left; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .modal-detail b { color: var(--accent); float: right; }
    </style>
</head>
<body>

    <div class="header">
        <i class="fas fa-arrow-left" onclick="window.location.href='wallet.html'"></i>
        <h2>ငွေသွင်း/ထုတ် မှတ်တမ်း</h2>
    </div>

    <div id="loading">
        <i class="fas fa-circle-notch fa-spin fa-2x"></i>
        <p style="margin-top:10px;">စာရင်းဆွဲနေသည်...</p>
    </div>

    <div id="no-data">မှတ်တမ်းမရှိသေးပါ။</div>
    <div id="history-container" class="history-list"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUk-1FHFjhIVDD4foYuKHM7PyT_A1A1vk",
            authDomain: "twod-aa6c1.firebaseapp.com",
            projectId: "twod-aa6c1",
            storageBucket: "twod-aa6c1.appspot.com",
            messagingSenderId: "674076613631",
            appId: "1:674076613631:android:b21b4027ebe6f6f169e5ca"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (user) { fetchHistory(user.uid); } 
            else { window.location.href = "login.html"; }
        });

        function fetchHistory(uid) {
            const q = query(collection(db, "transactions"), where("uid", "==", uid));

            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('history-container');
                document.getElementById('loading').style.display = 'none';
                container.innerHTML = "";

                if (snapshot.empty) {
                    document.getElementById('no-data').style.display = 'block';
                    return;
                }

                document.getElementById('no-data').style.display = 'none';

                let docs = [];
                snapshot.forEach(d => {
                    let data = d.data();
                    data.id = d.id; // doc id သိမ်းထားရန်
                    docs.push(data);
                });
                
                docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                docs.forEach((data) => {
                    const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : "စောင့်ဆိုင်းဆဲ";
                    const statusLabel = data.status === 'success' ? 'အောင်မြင်' : (data.status === 'rejected' ? 'ငြင်းပယ်' : 'စောင့်ဆိုင်းဆဲ');
                    const color = data.status === 'success' ? '#52c41a' : (data.status === 'rejected' ? '#ff4d4f' : '#faad14');

                    const card = document.createElement('div');
                    card.className = 'history-card';
                    card.style.borderLeftColor = color;
                    card.onclick = () => showDetail(data, date, statusLabel);

                    card.innerHTML = `
                        <div class="row">
                            <span class="type">${data.type === 'deposit' ? 'ငွေသွင်း' : 'ငွေထုတ်'} (${data.method})</span>
                            <span class="amount">${data.amount.toLocaleString()} Ks</span>
                        </div>
                        <div class="row" style="margin-bottom:0;">
                            <span class="date">${date}</span>
                            <span class="status-${data.status}">${statusLabel}</span>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        window.showDetail = (data, date, statusLabel) => {
            Swal.fire({
                title: 'အသေးစိတ်အချက်အလက်',
                background: '#003366',
                color: '#fff',
                html: `
                    <div class="modal-detail">
                        <p>အမျိုးအစား: <b>${data.type === 'deposit' ? 'ငွေသွင်း' : 'ငွေထုတ်'}</b></p>
                        <p>ပမာဏ: <b>${data.amount.toLocaleString()} Ks</b></p>
                        <p>ဝန်ဆောင်မှု: <b>${data.method}</b></p>
                        <p>ဖုန်းနံပါတ်: <b>${data.phone}</b></p>
                        ${data.type === 'deposit' ? `<p>လုပ်ငန်းစဉ်အမှတ်: <b>${data.transactionId || '-'}</b></p>` : ''}
                        <p>အချိန်: <b>${date}</b></p>
                        <p>အခြေအနေ: <b style="color:${data.status === 'success' ? '#52c41a' : (data.status === 'rejected' ? '#ff4d4f' : '#faad14')}">${statusLabel}</b></p>
                    </div>
                `,
                confirmButtonText: 'ပိတ်မည်',
                confirmButtonColor: '#1890ff'
            });
        };
    </script>
</body>
</html>
